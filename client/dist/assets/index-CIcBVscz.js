var T=Object.defineProperty;var N=(h,t,e)=>t in h?T(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var c=(h,t,e)=>N(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();class R{constructor(){c(this,"gameOutput");c(this,"statusBar",{});c(this,"panels",{});c(this,"modals",{});c(this,"roomsData",[]);c(this,"visitedRooms",new Set);c(this,"currentRoomId","");this.gameOutput=document.getElementById("game-output"),this.statusBar={playerName:document.getElementById("player-name"),location:document.getElementById("location"),hpBar:document.getElementById("hp-bar"),hpText:document.getElementById("hp-text"),mpBar:document.getElementById("mp-bar"),mpText:document.getElementById("mp-text"),gold:document.getElementById("gold"),level:document.getElementById("level")},this.panels={stats:document.getElementById("stats-panel"),inventory:document.getElementById("inventory-panel"),equipment:document.getElementById("equipment-panel"),spells:document.getElementById("spells-panel"),effects:document.getElementById("effects-panel")},this.modals={overlay:document.getElementById("modal-overlay"),title:document.getElementById("modal-title"),content:document.getElementById("modal-content")},this.loadRoomsData()}addMessage(t,e=""){const s=document.createElement("div");s.className=`message ${e}`;const n=this.processText(t);s.innerHTML=n,this.gameOutput.appendChild(s),this.gameOutput.scrollTop=this.gameOutput.scrollHeight}processText(t){return t.split(`

`).map(n=>{if(!n.trim())return"";const o=n.split(`
`);return o.every(m=>m.trim().startsWith("- ")||m.trim().startsWith("* "))?`<ul>${o.map(d=>`<li>${d.trim().substring(2)}</li>`).join("")}</ul>`:`<p>${n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`(.+?)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}</p>`}).join("")}clearMessages(){this.gameOutput.innerHTML=""}updatePlayerDisplay(t){if(t.name&&(this.statusBar.playerName.textContent=t.name),t.location){this.currentRoomId=t.location;const e=this.roomsData.find(s=>s.identity.id===t.location);e?this.statusBar.location.textContent=e.identity.canonicalName:this.statusBar.location.textContent=t.location}if(t.visitedRooms&&(this.visitedRooms=new Set(t.visitedRooms)),t.hp!==void 0&&t.maxHp!==void 0){const e=t.hp/t.maxHp*100;this.statusBar.hpBar.style.width=`${e}%`,this.statusBar.hpText.textContent=`${t.hp}/${t.maxHp}`}if(t.mp!==void 0&&t.maxMp!==void 0){const e=t.mp/t.maxMp*100;this.statusBar.mpBar.style.width=`${e}%`,this.statusBar.mpText.textContent=`${t.mp}/${t.maxMp}`}if(t.gold!==void 0&&(this.statusBar.gold.textContent=`${t.gold} Gold`),t.level!==void 0&&(this.statusBar.level.textContent=`Lvl ${t.level}`),t.stats)for(const[e,s]of Object.entries(t.stats)){const n=document.getElementById(`stat-${e.toLowerCase()}`);n&&(n.textContent=String(s))}t.inventory&&this.updateInventory(t.inventory),t.equippedItems&&this.updateEquipment(t.equippedItems,t.inventory,t.flags||{}),t.skills!==void 0&&this.updateSpells(t.skills),t.statusEffects&&this.updateEffects(t.statusEffects)}updateInventory(t){if(t.length===0){this.panels.inventory.innerHTML='<p class="empty-text">Empty</p>';return}const e=t.map(s=>`
      <div class="inventory-item" data-item-id="${s.id}">
        <span class="item-name">${s.name}</span>
        ${s.quantity>1?`<span class="item-qty">x${s.quantity}</span>`:""}
      </div>
    `).join("");this.panels.inventory.innerHTML=e}updateEquipment(t,e,s){const n=["weapon","armor","accessory","light"];for(const o of n){const i=document.getElementById(`equip-${o}`);if(i){const d=t[o==="light"?"light_source":o];if(d){const f=d.replace(/_/g," ").split(" ").map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" ");i.textContent=f,o==="light"&&(s[`${d}_on`]||!1?(i.style.color="#ffffff",i.style.fontWeight="bold"):(i.style.color="",i.style.fontWeight=""))}else i.textContent="---",i.style.color="",i.style.fontWeight=""}}}updateSpells(t){if(t.length===0){this.panels.spells.innerHTML='<p class="empty-text">None learned</p>';return}const e={mental_focus:"Mental Focus",telekinesis:"Telekinesis",mind_shield:"Mind Shield",psionic_blast:"Psionic Blast",neural_link:"Neural Link"},s=t.map(n=>`
        <div class="spell-item">
          <span class="spell-icon">‚ú¶</span>
          <span class="spell-name">${e[n]||n.replace(/_/g," ").replace(/\b\w/g,i=>i.toUpperCase())}</span>
        </div>
      `).join("");this.panels.spells.innerHTML=s}updateEffects(t){if(t.length===0){this.panels.effects.innerHTML='<p class="empty-text">None</p>';return}const e=t.map(s=>`
      <div class="effect-item">
        <span class="effect-icon">‚ö°</span>
        <span class="effect-name">${s.name}</span>
        <span class="effect-duration">${s.duration}t</span>
      </div>
    `).join("");this.panels.effects.innerHTML=e}setConnectionStatus(t){let e=document.querySelector(".connection-status");e||(e=document.createElement("div"),e.className="connection-status",e.innerHTML='<span class="connection-dot"></span><span class="connection-text">Connected</span>',document.body.appendChild(e)),e.className=`connection-status ${t}`;const s=e.querySelector(".connection-text");if(s)switch(t){case"connected":s.textContent="Connected";break;case"connecting":s.textContent="Connecting...";break;case"disconnected":s.textContent="Disconnected";break}}openModal(t,e,s){const n={map:"üó∫Ô∏è Map",details:"üìã Details",hint:"üí° Hint",inventory:"üéí Inventory",character:"üë§ Character",help:"‚ùì Help"};this.modals.title.textContent=n[t]||"Information",e?this.modals.content.innerHTML=this.processText(e):t==="hint"?this.renderHint(s):t==="help"&&this.renderHelp(),this.modals.overlay.classList.remove("hidden")}closeModal(){this.modals.overlay.classList.add("hidden")}renderHint(t){const e=(t==null?void 0:t.hint)||"No hints available at this time.";this.modals.content.innerHTML=`
      <div class="hint-container">
        <div class="hint-icon">üí°</div>
        <div class="hint-text">${e}</div>
        <p class="hint-warning">Hints may reduce the challenge of discovery!</p>
      </div>
    `}renderHelp(){this.modals.content.innerHTML=`
      <h4>Movement</h4>
      <p>Use <code>go [direction]</code> or just the direction name: <code>north</code>, <code>south</code>, <code>east</code>, <code>west</code>, <code>up</code>, <code>down</code></p>
      <p>Shortcuts: <code>n</code>, <code>s</code>, <code>e</code>, <code>w</code>, <code>u</code>, <code>d</code></p>

      <h4>Looking</h4>
      <ul>
        <li><code>look</code> - Examine your surroundings</li>
        <li><code>examine [object]</code> - Look closely at something</li>
      </ul>

      <h4>Items</h4>
      <ul>
        <li><code>take [item]</code> - Pick up an item</li>
        <li><code>drop [item]</code> - Drop an item</li>
        <li><code>inventory</code> or <code>i</code> - List your items</li>
        <li><code>use [item]</code> - Use an item</li>
      </ul>

      <h4>Interaction</h4>
      <ul>
        <li><code>open [object]</code> - Open a container or door</li>
        <li><code>close [object]</code> - Close something</li>
        <li><code>put [item] in [container]</code> - Place an item</li>
      </ul>

      <h4>Combat</h4>
      <ul>
        <li><code>attack</code> - Attack an enemy</li>
        <li><code>cast [spell]</code> - Cast a psionic spell</li>
      </ul>

      <h4>Other</h4>
      <ul>
        <li><code>rest</code> - Rest to recover HP/MP</li>
        <li><code>help</code> - Show this help</li>
      </ul>
    `}showCombat(t){const e=document.getElementById("combat-overlay");if(e==null||e.classList.remove("hidden"),t){const s=document.getElementById("enemy-name"),n=document.getElementById("enemy-hp-bar"),o=document.getElementById("enemy-hp-text");s&&(s.textContent=t.name),n&&(n.style.width=`${t.hp/t.maxHp*100}%`),o&&(o.textContent=`${t.hp}/${t.maxHp}`)}}hideCombat(){const t=document.getElementById("combat-overlay");t==null||t.classList.add("hidden")}addCombatLog(t,e=""){const s=document.getElementById("combat-log");if(s){const n=document.createElement("div");n.className=`log-entry ${e}`,n.textContent=t,s.appendChild(n),s.scrollTop=s.scrollHeight}}clearCombatLog(){const t=document.getElementById("combat-log");t&&(t.innerHTML="")}showToast(t,e="info"){let s=document.getElementById("toast-container");s||(s=document.createElement("div"),s.id="toast-container",document.body.appendChild(s));const n=document.createElement("div");n.className=`toast ${e}`,n.textContent=t,s.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(100%)",setTimeout(()=>n.remove(),300)},5e3)}async loadRoomsData(){try{const t=await fetch("/data/rooms/station_area.json");this.roomsData=await t.json()}catch(t){console.error("Failed to load rooms data:",t)}}showMap(){const t=document.getElementById("map-overlay");t&&(t.classList.remove("hidden"),this.renderMapSVG())}closeMap(){const t=document.getElementById("map-overlay");t&&t.classList.add("hidden")}renderMapSVG(){const t=document.getElementById("map-svg");if(!t||this.roomsData.length===0)return;t.innerHTML="";const e=new Map;this.roomsData.forEach(l=>{e.set(l.identity.id,l)});const s=new Map;let n=1/0,o=-1/0,i=1/0,m=-1/0;this.roomsData.forEach(l=>{var u;const r=(u=l.meta)==null?void 0:u.mapCoordinates;r&&(s.set(l.identity.id,{x:r.x,y:r.y}),n=Math.min(n,r.x),o=Math.max(o,r.x),i=Math.min(i,r.y),m=Math.max(m,r.y))});const d=80,f=25,a=100,y=100,x=(o-n)*a+d*2,S=(m-i)*y+d*2;t.setAttribute("viewBox",`0 0 ${x} ${S}`),t.setAttribute("width",x.toString()),t.setAttribute("height",S.toString());const b=l=>(l-n)*a+d,B=l=>(m-l)*y+d;this.roomsData.forEach(l=>{const r=l.identity.id,u=s.get(r);if(!u)return;const w=l.exits||{};Object.entries(w).forEach(([L,p])=>{const v=p.to;if(!v)return;const M=s.get(v);if(!M||r>v)return;const E=b(u.x),I=B(u.y),H=b(M.x),C=B(M.y),g=document.createElementNS("http://www.w3.org/2000/svg","line");g.setAttribute("x1",E.toString()),g.setAttribute("y1",I.toString()),g.setAttribute("x2",H.toString()),g.setAttribute("y2",C.toString());const $=this.visitedRooms.has(r)&&this.visitedRooms.has(v);g.classList.add("map-connection"),$&&g.classList.add("visited"),t.appendChild(g)})}),this.roomsData.forEach(l=>{const r=l.identity.id,u=s.get(r);if(!u)return;const w=b(u.x),L=B(u.y),p=document.createElementNS("http://www.w3.org/2000/svg","g");p.classList.add("map-node");const v=this.visitedRooms.has(r);r===this.currentRoomId?p.classList.add("current"):v?p.classList.add("visited"):p.classList.add("unvisited");const E=document.createElementNS("http://www.w3.org/2000/svg","circle");E.setAttribute("cx",w.toString()),E.setAttribute("cy",L.toString()),E.setAttribute("r",f.toString()),p.appendChild(E);const I=document.createElementNS("http://www.w3.org/2000/svg","text");I.setAttribute("x",w.toString()),I.setAttribute("y",(L+4).toString());const H=r.replace("ROOM_","").replace(/^0+/,"");I.textContent=H,p.appendChild(I);const C=document.createElementNS("http://www.w3.org/2000/svg","title");C.textContent=l.identity.canonicalName,p.appendChild(C),t.appendChild(p)})}}const k="shadowchronicles_save";class A{constructor(){c(this,"state",{player:null,currentRoom:null,lastSaved:0});this.loadFromStorage()}loadFromStorage(){try{const t=localStorage.getItem(k);if(t){const e=JSON.parse(t);this.state=e,console.log("Loaded saved game state")}}catch(t){console.warn("Failed to load saved state:",t)}}saveState(){try{this.state.lastSaved=Date.now(),localStorage.setItem(k,JSON.stringify(this.state))}catch(t){console.error("Failed to save state:",t)}}clearState(){localStorage.removeItem(k),this.state={player:null,currentRoom:null,lastSaved:0}}updatePlayer(t){this.state.player||(this.state.player={name:"Unknown",hp:100,maxHp:100,mp:50,maxMp:50,gold:0,xp:0,level:1,stats:{STR:10,DEX:10,INT:10,WIS:10,CHA:10,CON:10},inventory:[],equippedItems:{},statusEffects:[],location:"",visitedRooms:[],flags:{}}),this.state.player={...this.state.player,...t}}updateRoom(t){this.state.currentRoom||(this.state.currentRoom={identity:{id:"",canonicalName:""},lighting:{},environment:{}}),this.state.currentRoom={...this.state.currentRoom,...t}}getPlayer(){return this.state.player}getRoom(){return this.state.currentRoom}getSavedState(){return this.state.player}getFullState(){return{...this.state}}isVisited(t){var e;return((e=this.state.player)==null?void 0:e.visitedRooms.includes(t))||!1}getFlag(t){var e;return((e=this.state.player)==null?void 0:e.flags[t])||!1}setFlag(t,e){this.state.player&&(this.state.player.flags[t]=e,this.saveState())}getInventoryItem(t){var e;return(e=this.state.player)==null?void 0:e.inventory.find(s=>s.id===t)}hasItem(t){var e;return((e=this.state.player)==null?void 0:e.inventory.some(s=>s.id===t))||!1}getLastSaved(){return this.state.lastSaved?new Date(this.state.lastSaved):null}}class D{constructor(){c(this,"socket",null);c(this,"sessionId",null);c(this,"ui");c(this,"state");c(this,"reconnectAttempts",0);c(this,"maxReconnectAttempts",5);c(this,"reconnectDelay",2e3);c(this,"messageHandlers",new Map);c(this,"commandHistory",[]);c(this,"historyIndex",-1);this.ui=new R,this.state=new A}init(){this.setupUI(),this.connect(),this.setupMessageHandlers(),this.loadSavedState()}setupUI(){var f;const t=document.getElementById("command-input"),e=document.getElementById("send-btn");t.addEventListener("keydown",a=>{a.key==="Enter"?(this.sendCommand(t.value),t.value=""):a.key==="ArrowUp"?(a.preventDefault(),this.navigateHistory(-1,t)):a.key==="ArrowDown"&&(a.preventDefault(),this.navigateHistory(1,t))}),e.addEventListener("click",()=>{this.sendCommand(t.value),t.value="",t.focus()});const s=document.getElementById("modal-close"),n=document.getElementById("modal-ok"),o=document.getElementById("modal-overlay");s==null||s.addEventListener("click",()=>this.ui.closeModal()),n==null||n.addEventListener("click",()=>this.ui.closeModal()),o==null||o.addEventListener("click",a=>{a.target===o&&this.ui.closeModal()});const i=document.getElementById("map-btn"),m=document.getElementById("map-close"),d=document.getElementById("map-overlay");i==null||i.addEventListener("click",()=>this.ui.showMap()),m==null||m.addEventListener("click",()=>this.ui.closeMap()),d==null||d.addEventListener("click",a=>{a.target===d&&this.ui.closeMap()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&(this.ui.closeModal(),this.ui.closeMap()),a.key==="m"&&!this.isTypingInInput()&&this.ui.showMap()}),document.querySelectorAll(".combat-btn").forEach(a=>{a.addEventListener("click",()=>{const y=a.dataset.action;y&&this.sendCommand(y)})}),(f=document.getElementById("inventory-panel"))==null||f.addEventListener("click",a=>{const x=a.target.closest(".inventory-item");if(x){const S=x.getAttribute("data-item-id");S&&this.sendCommand(`examine ${S}`)}})}connect(){const t=this.getWebSocketUrl();this.ui.setConnectionStatus("connecting"),this.ui.addMessage("Connecting to server...","system");try{this.socket=new WebSocket(t),this.socket.onopen=()=>{this.reconnectAttempts=0,this.ui.setConnectionStatus("connected");const e=this.state.getSavedState();this.send({type:"connect",timestamp:Date.now(),sessionId:this.sessionId||"",savedState:e?JSON.stringify(e):void 0})},this.socket.onmessage=e=>{try{const s=JSON.parse(e.data);this.handleMessage(s)}catch(s){console.error("Failed to parse message:",s)}},this.socket.onclose=()=>{this.ui.setConnectionStatus("disconnected"),this.attemptReconnect()},this.socket.onerror=e=>{console.error("WebSocket error:",e),this.ui.addMessage("Connection error. Retrying...","error")}}catch(e){console.error("Failed to create WebSocket:",e),this.attemptReconnect()}}getWebSocketUrl(){const t=window.location.protocol==="https:"?"wss:":"ws:",e=window.location.hostname||"localhost";return`${t}//${e}:8080`}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.ui.addMessage("Unable to connect to server. Please refresh the page.","error");return}this.reconnectAttempts++;const t=this.reconnectDelay*this.reconnectAttempts;this.ui.addMessage(`Reconnecting in ${t/1e3} seconds... (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`,"system"),setTimeout(()=>this.connect(),t)}setupMessageHandlers(){this.on("response",t=>{this.ui.addMessage(t.text,t.className||"response")}),this.on("state_update",t=>{t.player&&(this.state.updatePlayer(t.player),this.ui.updatePlayerDisplay(t.player),this.state.saveState()),t.room&&this.state.updateRoom(t.room)}),this.on("error",t=>{this.ui.addMessage(`Error: ${t.message}`,"error")}),this.on("combat_start",t=>{this.ui.showCombat(t.enemy)}),this.on("combat_end",t=>{this.ui.hideCombat(),t.result==="victory"?this.ui.addMessage("Victory!","response"):t.result==="defeat"&&this.ui.addMessage("You have been defeated...","error")}),this.on("modal_open",t=>{this.ui.openModal(t.modalType,t.content,t.data)}),this.on("modal_close",()=>{this.ui.closeModal()})}handleMessage(t){t.sessionId&&!this.sessionId&&(this.sessionId=t.sessionId);const e=this.messageHandlers.get(t.type);e&&e.forEach(s=>s(t))}on(t,e){this.messageHandlers.has(t)||this.messageHandlers.set(t,[]),this.messageHandlers.get(t).push(e)}isTypingInInput(){const t=document.activeElement;return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(t)):console.warn("Cannot send message: WebSocket not connected")}sendCommand(t){const e=t.trim();e&&(this.commandHistory.push(e),this.commandHistory.length>100&&this.commandHistory.shift(),this.historyIndex=this.commandHistory.length,this.ui.addMessage(e,"command"),this.send({type:"command",timestamp:Date.now(),sessionId:this.sessionId||"",command:e,raw:e}))}navigateHistory(t,e){const s=this.historyIndex+t;s<0||s>this.commandHistory.length||(this.historyIndex=s,s===this.commandHistory.length?e.value="":e.value=this.commandHistory[s],setTimeout(()=>{e.selectionStart=e.selectionEnd=e.value.length},0))}loadSavedState(){const t=this.state.getSavedState();t&&this.ui.updatePlayerDisplay(t)}getState(){return this.state.getFullState()}clearState(){this.state.clearState(),window.location.reload()}}document.addEventListener("DOMContentLoaded",()=>{const h=new D;h.init(),window.gameClient=h});
